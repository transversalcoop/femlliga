{% extends "femlliga/_base_template.html" %}

{% from 'femlliga/_macros.html' import render_select_raw, resource_details, render_match_badges, organization_link %}

{% macro show_matches(resource, matches, match_type, match_name) %}
  {% set others = matches[resource.resource] %}
  {% for result in others %}
  <div class="divider-2"></div>
  <div class="row">
    <h3>
      {{ organization_link(result.organization) }}
      <span style="border-bottom: 2px solid black;">{{ match_name }}</span>
      {{ resource_name(resource.resource) }}
    </h3>
    <div>
      <span style="margin-right: 15px;">A {{ org.distance_text(result.organization) }} de vosaltres</span>
      <a href="{{ url("send_message", args=[org.id, result.organization.id, match_type, result.resource]) }}" style="text-decoration: none;">
        <i class="bi-send" style="font-size: 1rem;"></i>
        Posa't en contacte amb {{ result.organization.name }}
      </a>
    </div>
    {{ resource_details(result, match_type) }}
  </div>
  {% endfor %}
{% endmacro %}

{% block content %}
{% if len(offer_matches) > 0 or len(need_matches) > 0 %}
<main id="content" class="container-fluid">
  <div class="row">
    <div class="col-md-4 d-md-block bg-light sidebar">
      <h1>Has lligat!</h1>
      <p>
        Hem trobat coincidències entre les vostres necessitats i les d'altres entitats, pots clicar a sota per veure'n els detalls
      </p>
      <div class="divider-2"></div>
      <ul class="nav nav-pills flex-column mb-auto">
        {% for resource in own_needs %}
          {% if resource.resource in offer_matches or resource.resource in need_matches %}
          <li class="nav-item">
            <button
              class="nav-link"
              type="button"
              role="tab"
              aria-selected="false"
              aria-current="page"
              data-bs-toggle="tab"
              style="width: 100%; text-align: left;"
              data-bs-target="#showDetails{{ resource.resource }}">
              <span style="float: right;">
                {{ render_match_badges(org, resource, offer_matches, need_matches) }}
              </span>
              {{ resource_name(resource.resource) }}
            </button>
          </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div class="col-md-8 ms-sm-auto px-md-4">
    {% for resource in own_needs %}
      {% if resource.resource in offer_matches or resource.resource in need_matches %}
        <div class="row collapse fade" id="showDetails{{ resource.resource }}" style="margin-top: 20px;">
          <div class="col-12">
            <p>Heu indicat que necessiteu un {{ resource_name(resource.resource) }}. A sota podeu veure quines entitats l'ofereixen per compartir-lo, i quines tenen també aquesta necessitat i amb les que podrieu contactar per buscar una solució comuna.</p>

            {{ show_matches(resource, offer_matches, "offer", "ofereix") }}
            {{ show_matches(resource, need_matches, "need", "també necessita") }}

          </div>
        </div>
      {% endif %}
    {% endfor %}
    </div>
  </div>
  <div id="app"></div>
</main>
{% else %}
<div class="container text-center pt-4">
  <h1>Sembla que no hi ha sort...</h1>
  <p>No cal patir! Amb el temps s'incorporaran noves entitats que probablement compartisquen les mateixes necessitats que vosaltres. Podeu tornar a comprovar-ho en uns dies.</p>
</div>
{% endif %}
{% endblock %}

{% block js %}
{{ json_script(matches_json, "matches-data") }}
{{ json_script(needs_json, "needs-data") }}
{{ json_script(consts.RESOURCE_NAMES_MAP, "resource-names-data") }}
<script>
(function() {
var matches = JSON.parse(document.getElementById('matches-data').textContent);
var needs = JSON.parse(document.getElementById('needs-data').textContent);
var resourceNamesMap = JSON.parse(document.getElementById('resource-names-data').textContent);

var state = {
    resourceSelected: "",
    search: "",
};

function updateState(key, value) {
    return function() {
        state[key] = value;
        m.redraw();
    };
}

var Badge = {
    view: function(vnode) {
        var resource = vnode.attrs.resource;
        var type = vnode.attrs.type;
        var map = type === "need" ? matches.need_matches : matches.offer_matches;
        return m("span.badge", {
            class: type === "need" ? "bg-warning" : "bg-success",
            title: type === "need" ?
              `Entitats que necessiten el mateix que vosaltres` :
              `Entitats que ofereixen el que necessiteu`,
        }, map[resource].length);
    },
};

var Sidebar = {
    view: function() {
        var resources = needs.filter(x => (x in matches.offer_matches || x in matches.need_matches));
        return m("ul.nav.nav-pills.flex-column.mb-auto", resources.map(function(resource) {
            return m("li.nav-item", [
                m("button.nav-link.w-100.text-start[type=button]", {
                    onclick: updateState("resourceSelected", resource),
                    class: state.resourceSelected === resource ? "active" : "",
                }, [
                    m("span.float-end", [
                        resource in matches.offer_matches ? m(Badge, {
                            resource: resource,
                            type: "offer",
                        }) : null,
                        " ",
                        resource in matches.need_matches ? m(Badge, {
                            resource: resource,
                            type: "need",
                        }) : null,
                    ]),
                    resourceNamesMap[resource],
                ]),
            ]);
        }));
    },
};

var Match = {
    view: function(vnode) {
        var match = vnode.attrs.match;
        return m(".row", [
            m(".divider-2"),
            m("h3", JSON.stringify(match)),
        ]);
    }
};

var Results = {
    view: function() {
        if (!state.resourceSelected) {
            return m("");
        }
        var elements = [
            m("p", `Heu indicat que necessiteu ${ resourceNamesMap[state.resourceSelected] }. A sota podeu veure quines entitats l'ofereixen per compartir-lo, i quines tenen també aquesta necessitat i amb les que podrieu contactar per buscar una solució comuna.`),
        ];
        var l = matches.offer_matches[state.resourceSelected];
        if (l) {
            for (var i = 0; i < l.length; i++) {
                elements.push(m(Match, { match: l[i], type: "offer" }));
            }
        }
        l = matches.need_matches[state.resourceSelected];
        if (l) {
            for (var i = 0; i < l.length; i++) {
                elements.push(m(Match, { match: l[i], type: "need" }));
            }
        }
        return m("div.row.collapse.fade.active.show", [
            m("div.col-12", elements),
        ]);
    },
};

var Layout = {
    view: function() {
        return m("div.row", [
            m("div.col-md-4.d-md-block.bg-light.sidebar", [
                m("h1", "Has lligat!"),
                m("p", "Hem trobat coincidències entre les vostres necessitats i les d'altres entitats, pots clicar a sota per veure'n els detalls"),
                m(".divider-2"),
                m(Sidebar),
            ]),
            m("div.col-md-8.ms-sm-auto.px-md-4", [m(Results)]),
        ]);
    }
};
m.mount(document.getElementById("app"), Layout);
})();
</script>
{% endblock %}
