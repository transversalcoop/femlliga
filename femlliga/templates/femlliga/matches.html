{% extends "femlliga/_base_template.html" %}

{% from 'femlliga/_macros.html' import render_select_raw, resource_details, render_match_badges, organization_link %}

{% block content %}
{% if len(offer_matches) > 0 or len(need_matches) > 0 %}
<main id="content" class="container-fluid">
  <div id="app" class="row">
    <div class="col-md-4 d-md-block bg-light sidebar">
      <h1>Has lligat!</h1>
      <p>
        Hem trobat coincidències entre les vostres necessitats i les d'altres entitats, pots clicar a sota per veure'n els detalls
      </p>
      <input v-model="search" type="text" class="form-control" placeholder="Cerca">
      <div class="divider-2"></div>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item" v-for="resource in matched_needs" :key="resource">
          <button
            @click="selectResource(resource)"
            class="nav-link w-100 text-start"
            type="button"
            role="tab"
            aria-selected="false"
            aria-current="page">
            <span class="float-end">
              {{ render_match_badge_vue("offerMatches", "bg-success", "Entitats que ofereixen el que necessiteu") }}
              <span></span>
              {{ render_match_badge_vue("needMatches", "bg-warning", "Entitats que necessiten el mateix que vosaltres") }}
            </span>
            ${ resourceNamesMap[resource] }
          </button>
        </li>
      </ul>
    </div>

    <div class="col-md-8 ms-sm-auto px-md-4">
      <div
        v-for="resource in matched_needs"
        :key="resource"
        class="row collapse fade mt-3"
        :class="{show: resourceSelected === resource}">
        <div class="col-12">
          <p>Heu indicat que necessiteu «${ resourceNamesMap[resource] }». A sota podeu veure quines entitats l'ofereixen per compartir-lo, i quines tenen també aquesta necessitat i amb les que podrieu contactar per buscar una solució comuna.</p>

          {{ show_matches_vue("offerMatches", "ofereix") }}
          {{ show_matches_vue("needMatches", "també necessita") }}
        </div>
      </div>
    </div>

    <div class="modal fade" id="images-modal" tabindex="-1" aria-labelledby="carouselModalImages" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-transparent">
          <div class="modal-header bg-white">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body bg-black bg-opacity-25">
            <div id="carousel-images" class="carousel slide" style="height: 100%;" data-bs-ride="carousel">
              <div class="carousel-inner">
                <div
                  v-for="(image, index) in carouselImages"
                  :key="image.url"
                  class="carousel-item text-center"
                  :class="{active: index === 0}">
                  <img :src="image.url" class="d-block" style="max-height: 100%; max-width: 80%; margin: 0 auto;">
                </div>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#carousel-images" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carousel-images" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% else %}
<div class="container text-center pt-4">
  <h1>Sembla que no hi ha sort...</h1>
  <p>No cal patir! Amb el temps s'incorporaran noves entitats que probablement compartisquen les mateixes necessitats que vosaltres. Podeu tornar a comprovar-ho en uns dies.</p>
</div>
{% endif %}

{% endblock %}

{% block js %}
{{ json_script(matches_json, "matches-data") }}
{{ json_script(needs_json, "needs-data") }}
{{ json_script(consts.RESOURCE_NAMES_MAP, "resource-names-data") }}
{{ json_script(consts.RESOURCE_OPTIONS_DEF_MAP, "option-names-data") }}
<script>
var matches = JSON.parse(document.getElementById('matches-data').textContent);
var needs = JSON.parse(document.getElementById('needs-data').textContent);
var resourceNamesMap = JSON.parse(document.getElementById('resource-names-data').textContent);
var optionNamesMap = JSON.parse(document.getElementById('option-names-data').textContent);

// TODO contains should be over several fields, over several words, and should highlight
function matchContains(search) {
    return function(m) {
        const parts = sanitize(search).split(" ");
        if (!parts.every((x) => contains(sanitize(m.organization.name), x))) {
            return false;
        }
        return true;
    };
}

Vue.createApp({
    delimiters: ["${", "}"],
    data() {
        return {
            needs: needs,
            allMatches: matches,
            resourceNamesMap: resourceNamesMap,
            optionNamesMap: optionNamesMap,
            search: "",
            resourceSelected: "",
            carouselImages: [],
        };
    },
    methods: {
        highlightSearch: highlightSearch,
        selectResource(resource) {
            this.resourceSelected = resource;
        },
        setCarouselImages(images) {
            this.carouselImages = images;
        },
        filterMatches(matches) {
            var m = {};
            for (var k in matches) {
                m[k] = matches[k].filter(matchContains(this.search));
            }
            return m;
        },
    },
    computed: {
        matched_needs() {
            return this.needs.filter(n => n in matches.offerMatches || n in matches.needMatches);
        },
        matches() {
            return {
                offerMatches: this.filterMatches(this.allMatches.offerMatches),
                needMatches: this.filterMatches(this.allMatches.needMatches),
            };
        },
    },
}).mount("#app");
</script>
{% endblock %}

{% macro render_match_badge_vue(match_type, color, title) %}
<span
  v-if="resource in matches.{{ match_type }}"
  class="badge ms-2 {{ color }}"
  title="{{ title }}">
  ${ matches.{{ match_type }}[resource].length }
</span>
{% endmacro %}

{% macro show_matches_vue(match_type, match_name) %}
  <div v-for="result in matches.{{ match_type }}[resource]" :key="result" class="row">
    <div class="divider-2"></div>
    <h3>
      <a :href="result.organization.href" v-html="highlightSearch(result.organization.name, search)"></a>
      <span class="strong-underline ms-2">{{ match_name }}</span>
      ${ resourceNamesMap[resource] }
    </h3>
    <div>
      <span class="me-3">A ${ result.distance } de vosaltres</span>
      <a :href="result.message_href" class="text-decoration-none">
        <i class="bi-send fs-6"></i>
        Posa't en contacte amb ${ result.organization.name }
      </a>
    </div>
    {{ resource_details_vue(match_type) }}
  </div>
{% endmacro %}

{% macro resource_details_vue(match_type) %}
<div style="margin-bottom: 10px;">
  <strong class="me-2">${ resourceNamesMap[result.resource] }</strong>
  <span v-if="result.charge" class="badge bg-light" title="Es demana remuneració a canvi">€</span>
  <span class="badge bg-light ms-2" v-for="option in result.options" :key="option">${ optionNamesMap[option] }</span>
</div>
<p v-if="result.comments"><strong>Observacions:</strong> ${ result.comments }</p>

<div v-if="result.images.length > 0" class="image-thumbnails">
  <div v-for="image in result.images" :key="image.url" class="thumbnail">
    <a data-bs-toggle="modal" href="#images-modal" role="button" @click="setCarouselImages(result.images)">
      <img :src="image.url">
    </a>
  </div>
</div>

{% endmacro %}
