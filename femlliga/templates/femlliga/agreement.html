{% extends "femlliga/_base_template.html" %}

{% from 'femlliga/_macros.html' import vue_js, initial_loading_vue %}

{% block title %}{{ _("Petició d'intercanvi") }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div id="app" class="row">
    <div class="col-md-4 d-md-block bg-light sidebar">
      {% if a.solicitor == org %}
      <h1>{{ _("Petició de %(resource)s enviada a <em>%(org)s</em>", resource=resource_name(a.resource), org=a.solicitee_safe().name) }}</h1>
      {% else %}
      <h1>{{ _("Petició de %(resource)s rebuda de <em>%(org)s</em>", resource=resource_name(a.resource), org=a.solicitor_safe().name) }}</h1>
      {% endif %}

      <div class="collapse show" id="sidebar-filter">
        <div>
        {% for option in a.options.all() %}
          <span class="badge bg-light me-2">{{ option }}</span>
        {% endfor %}
        </div>
        <p class="mt-2">
          <i class="bi-send"></i>
          {{ _("Petició enviada el %(time)s", time=format_time(a.date)) }}
        </p>
        {% if a.agreement_successful == True %}
        <p>
          <i class="bi-check2 text-success"></i>
          {{ _("Es va arribar a un acord") }}
        </p>
        {% elif a.agreement_successful == False %}
        <p>
          <i class="bi-x-lg text-danger"></i>
          {{ _("No es va arribar a un acord") }}
        </p>
        {% else %}
        <p class="mt-5">{{ _("Heu realitzat l'intercanvi?") }}</p>
        <div>
          <button class="btn btn-warning w-100 mb-2">{{ _("Si, hem realitzat l'intercanvi!") }}</button>
          <button class="btn btn-brown w-100">{{ _("No, finalment no hem realitzat l'intercanvi...") }}</button>
        </div>
        {% endif %}
      </div>
    </div>

    <div id="vue-app" class="col-md-8">
      <div class="alert alert-warning mt-2">
        TODO FL103 missatge inicial, guió 1 -> 2 -> 3 -> 4 amb els passos a seguir
        TODO FL103 traduïr totes les cadenes
      </div>

      {{ initial_loading_vue() }}
      <template v-else>
        <div v-for="m of messages" class="row">
          <div v-if="m.sent_by === org_id" class="col-9 offset-3 col-lg-6 offset-lg-6">
            <p class="fs-7 mb-0"><em>Missatge enviat el ${ formatDateTime(m.sent_on) }</em></p>
            <div class="alert alert-success pre-wrap">${ m.message }</div>
          </div>
          <div v-else class="col-9 col-lg-6">
            <p class="fs-7 mb-0"><em>Missatge rebut el ${ formatDateTime(m.sent_on) }</em></p>
            <div class="alert alert-secondary pre-wrap">${ m.message }</div>
          </div>
        </div>
      </template>

      {% if not a.solicitor or not a.solicitee %}
      <p><em>{{ _("No es poden enviar més missatges en aquesta conversa perquè l'altra organització ja no existeix") }}</em></p>
      {% elif a.agreement_successful == None %}
      <form method="post" action="{{ url("send_agreement_message", kwargs={'organization_id': org.id, 'agreement_id': a.id}) }}" @submit="send">
        {{ csrf_input }}
        <textarea v-model="message" class="form-control" name="message"></textarea>
        <button class="btn btn-warning mt-2">{{ _("Envia") }}</button>
      </form>
      {% else %}
      <div class="row">
        <div class="col-12 col-lg-8 offset-lg-2">
          <div class="alert alert-warning">
            {% if a.agreement_successful == True %}
            TODO FL103 fer bé S'ha arribat a un acord
            {% else %}
            TODO FL103 fer bé No S'ha arribat a un acord
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
{{ vue_js() }}
<script>
Vue.createApp({
  delimiters: ["${", "}"],
  data() {
    const jsonData = getJsonData();
    console.log("JSON DATA:", jsonData);
    return {
      agreement_id: jsonData.agreement_id,
      org_id: jsonData.org_id,
      messages: jsonData.messages,
      message: "",
    };
  },
  mounted() {
    try {
      let protocol = "wss";
      if (window.location.protocol === "http:") {
        protocol = "ws";
      }
      let url = `${protocol}://${window.location.host}/ws/organization/${this.org_id}/agreements/${this.agreement_id}/`;
      this.socket = new WebSocket(url);
      this.socket.onmessage = (e) => {
        this.messages.push(JSON.parse(e.data));
      };
      this.socket.onclose = (e) => {
        console.error("Chat connection closed");
      };
    } catch(e) {
      this.socket = undefined;
    }
  },
  methods: {
    formatDateTime: formatDateTime,
    send(e) {
      // if socket not working, form is sent normally and page reloaded
      if (this.socket) {
        e.preventDefault();
        this.socket.send(JSON.stringify({ "message": this.message }));
        this.message = "";
      }
    }
  },
}).mount("#app");
</script>
{% endblock %}
