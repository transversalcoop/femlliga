{% extends "femlliga/_base_template.html" %}

{% from 'femlliga/_macros.html' import vue_js, initial_loading_vue %}

{% block title %}{{ _("Petició d'intercanvi") }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div id="app" class="row">
    <div class="col-md-4 d-md-block bg-light sidebar">
      {% if a.solicitor == org %}
      <h1>{{ _("Petició de %(resource)s enviada a <em>%(org)s</em>", resource=resource_name(a.resource), org=a.solicitee_safe().name) }}</h1>
      {% else %}
      <h1>{{ _("Petició de %(resource)s rebuda de <em>%(org)s</em>", resource=resource_name(a.resource), org=a.solicitor_safe().name) }}</h1>
      {% endif %}

      <div id="confirm-question" class="d-none">{{ _("Segur que vols marcar aquesta opció? L'acció no es pot desfer") }}</div>
      <div class="collapse show" id="sidebar-filter">
        <div>
        {% for option in a.options.all() %}
          <span class="badge bg-light me-2">{{ option }}</span>
        {% endfor %}
        </div>
        {% if a.agreement_successful == None %}
        <p class="mt-2">{{ _("Heu realitzat l'intercanvi? Indiqueu-ho per donar per acabada la conversa.") }}</p>
        <form method="post" action="{{ url("agreement_successful", kwargs={'organization_id': org.id, 'agreement_id': a.id}) }}" onsubmit="return confirm(document.getElementById('confirm-question').textContent)">
          {{ csrf_input }}
          <input type="hidden" name="successful" value="yes">
          <button class="btn btn-warning w-100 mb-2">{{ _("Si, hem realitzat l'intercanvi!") }}</button>
        </form>
        <form method="post" action="{{ url("agreement_successful", kwargs={'organization_id': org.id, 'agreement_id': a.id}) }}" onsubmit="return confirm(document.getElementById('confirm-question').textContent)">
          {{ csrf_input }}
          <input type="hidden" name="successful" value="no">
          <button class="btn btn-brown w-100">{{ _("No, finalment no hem realitzat l'intercanvi...") }}</button>
        </form>
        {% endif %}
      </div>
    </div>

    <div id="vue-app" class="col-md-8">
      <div class="alert alert-warning mt-2 text-center">
        <div class="row">
          <div class="col-3"><span class="fs-1">1</span></div>
          <div class="col-3"><span class="fs-1">2</span></div>
          <div class="col-3"><span class="fs-1">3</span></div>
          <div class="col-3"><span class="fs-1">4</span></div>
        </div>
        <div class="row">
          <div class="col-3">{{ _("Has fet una petició d'un recurs") }}</div>
          <div class="col-3">{{ _("Entrem en contacte? Parlem!") }}</div>
          <div class="col-3">{{ _("Concretem dia i hora per trobar-nos?") }}</div>
          <div class="col-3">{{ _("Realitzem l'intercanvi!") }}</div>
        </div>
      </div>

      {{ initial_loading_vue() }}
      <template v-else>
        <div v-for="m of messages" class="row">
          <div v-if="m.sent_by === org_id" class="col-9 offset-3 col-lg-6 offset-lg-6">
            <p class="fs-7 mb-0"><em>{{ _("Missatge enviat el") }} ${ formatDateTime(m.sent_on) }</em></p>
            <div class="alert alert-success pre-wrap">${ m.message }</div>
          </div>
          <div v-else class="col-9 col-lg-6">
            <p class="fs-7 mb-0"><em>{{ _("Missatge rebut el") }} ${ formatDateTime(m.sent_on) }</em></p>
            <div class="alert alert-secondary pre-wrap">${ m.message }</div>
          </div>
        </div>
      </template>

      {% if not a.solicitor or not a.solicitee %}
      <p><em>{{ _("No es poden enviar més missatges en aquesta conversa perquè l'altra organització ja no existeix") }}</em></p>
      {% elif a.agreement_successful == None %}
      <form method="post" action="{{ url("send_agreement_message", kwargs={'organization_id': org.id, 'agreement_id': a.id}) }}" @submit="send">
        {{ csrf_input }}
        <textarea v-model="message" class="form-control" name="message"></textarea>
        <button class="btn btn-warning mt-2">{{ _("Envia") }}</button>
      </form>
      {% else %}
      <div class="row">
        <div class="col-12 col-lg-8 offset-lg-2">
          <div class="alert alert-warning">
            {% if a.agreement_successful == True %}
            {{ _("Es va indicar que s'havia realitzat l'intercanvi el %(time)s", time=format_time(a.successful_date)) }}
            {% else %}
            {{ _("Es va indicar que <strong>no</strong> s'havia realitzat l'intercanvi el %(time)s", time=format_time(a.successful_date)) }}
            {% endif %}
            <br />
            {{ _("Ja no es poden enviar més missatges en aquesta conversa. Si voleu realitzar un intercanvi de nou, podeu sol·licitar-ho a través de les pàgines de «Has lligat?» o «Descobreix»") }}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
{{ vue_js() }}
<script>
Vue.createApp({
  delimiters: ["${", "}"],
  data() {
    const jsonData = getJsonData();
    return {
      agreement_id: jsonData.agreement_id,
      org_id: jsonData.org_id,
      messages: jsonData.messages,
      message: "",
    };
  },
  mounted() {
    for (let message of this.messages) {
      this.markRead(message);
    }
    try {
      let protocol = "wss";
      if (window.location.protocol === "http:") {
        protocol = "ws";
      }
      let url = `${protocol}://${window.location.host}/ws/organization/${this.org_id}/agreements/${this.agreement_id}/`;
      this.socket = new WebSocket(url);
      this.socket.onmessage = (e) => {
        let message = JSON.parse(e.data);
        this.messages.push(message);
        this.markRead(message);
      };
      this.socket.onclose = (e) => {
        console.error("Chat connection closed");
      };
    } catch(e) {
      this.socket = undefined;
    }
  },
  methods: {
    formatDateTime: formatDateTime,
    send(e) {
      // if socket not working, form is sent normally and page reloaded
      if (this.socket) {
        e.preventDefault();
        this.socket.send(JSON.stringify({ "message": this.message }));
        this.message = "";
      }
    },
    markRead(message) {
      if (!message.read && message.sent_by !== this.org_id) { // received
        let url = `/organization/${this.org_id}/agreements/${this.agreement_id}/messages/${message.id}/mark-read/`;
        post(url, "{{ csrf_token }}", {});
      }
    },
  },
}).mount("#app");
</script>
{% endblock %}
